name: NGO Ranking Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at midnight
    - cron: '0 0 * * 0'

env:
  DOCKER_IMAGE: cfi-midot-ranking
  RANKED_NGO_FNAME: ${{ secrets.RANKED_NGO_FNAME }}
  PUBLIC_SPREADSHEET_ID: ${{ secrets.PUBLIC_SPREADSHEET_ID }}
  GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
  GMAIL_SMTP_USER: ${{ secrets.GMAIL_SMTP_USER }}
  GMAIL_SMTP_PASSWORD: ${{ secrets.GMAIL_SMTP_PASSWORD }}
  EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
  EMAIL_TO: ${{ secrets.EMAIL_TO }}
  REMOTE_PROPER_MANAGEMENT_URL: ${{ secrets.REMOTE_PROPER_MANAGEMENT_URL }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: docker save ${{ env.DOCKER_IMAGE }}:${{ github.sha }} | gzip > docker-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 1

  scrape:
    name: Scrape NGO Data
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Create data directory
        run: mkdir -p data

      - name: Backup previous proper management data
        run: |
          if [ -f data/NgoProperManagement.csv ]; then
            cp data/NgoProperManagement.csv data/NgoProperManagement_previous.csv
            echo "Backed up previous proper management data"
          else
            echo "No previous proper management data found"
          fi

      - name: Run scrape job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -v ${{ github.workspace }}/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python scrape.py

      - name: Upload scraped data
        uses: actions/upload-artifact@v4
        with:
          name: scraped-data
          path: data/
          retention-days: 7

  rank:
    name: Rank NGOs
    runs-on: ubuntu-latest
    needs: [build, scrape]
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download scraped data
        uses: actions/download-artifact@v4
        with:
          name: scraped-data
          path: data/

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run rank job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -v ${{ github.workspace }}/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python rank.py

      - name: Upload ranked data
        uses: actions/upload-artifact@v4
        with:
          name: ranked-data
          path: data/
          retention-days: 7

  upload:
    name: Upload to Google Sheets
    runs-on: ubuntu-latest
    needs: [build, rank]
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download ranked data
        uses: actions/download-artifact@v4
        with:
          name: ranked-data
          path: data/

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run upload job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -e PUBLIC_SPREADSHEET_ID="${{ env.PUBLIC_SPREADSHEET_ID }}" \
            -e GOOGLE_CREDENTIALS_JSON="${{ env.GOOGLE_CREDENTIALS_JSON }}" \
            -v ${{ github.workspace }}/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python upload.py

  check-proper-management:
    name: Check Proper Management Changes
    runs-on: ubuntu-latest
    needs: [build, scrape]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download scraped data
        uses: actions/download-artifact@v4
        with:
          name: scraped-data
          path: data/

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run proper management check
        run: |
          docker run --rm \
            -e GMAIL_SMTP_USER="${{ env.GMAIL_SMTP_USER }}" \
            -e GMAIL_SMTP_PASSWORD="${{ env.GMAIL_SMTP_PASSWORD }}" \
            -e EMAIL_FROM="${{ env.EMAIL_FROM }}" \
            -e EMAIL_TO="${{ env.EMAIL_TO }}" \
            -e REMOTE_PROPER_MANAGEMENT_URL="${{ env.REMOTE_PROPER_MANAGEMENT_URL }}" \
            -v ${{ github.workspace }}/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python check_proper_management.py

      - name: Commit updated proper management data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Copy new data to replace the tracked file
          if [ -f data/NgoProperManagement.csv ]; then
            git add data/NgoProperManagement.csv -f
            git diff --staged --quiet || git commit -m "Update proper management data [skip ci]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
