name: NGO Ranking Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at midnight
    - cron: '0 0 * * 0'

env:
  DOCKER_IMAGE: cfi-midot-ranking
  RANKED_NGO_FNAME: ${{ secrets.RANKED_NGO_FNAME }}
  PUBLIC_SPREADSHEET_ID: ${{ secrets.PUBLIC_SPREADSHEET_ID }}
  GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: docker save ${{ env.DOCKER_IMAGE }}:${{ github.sha }} | gzip > docker-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 1

  scrape:
    name: Scrape NGO Data
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run scrape job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -v $(pwd)/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python scrape.py

      - name: Upload scraped data
        uses: actions/upload-artifact@v4
        with:
          name: scraped-data
          path: data/
          retention-days: 7

  rank:
    name: Rank NGOs
    runs-on: ubuntu-latest
    needs: [build, scrape]
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download scraped data
        uses: actions/download-artifact@v4
        with:
          name: scraped-data
          path: data/

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run rank job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -v $(pwd)/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python rank.py

      - name: Upload ranked data
        uses: actions/upload-artifact@v4
        with:
          name: ranked-data
          path: data/
          retention-days: 7

  upload:
    name: Upload to Google Sheets
    runs-on: ubuntu-latest
    needs: [build, rank]
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Download ranked data
        uses: actions/download-artifact@v4
        with:
          name: ranked-data
          path: data/

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run upload job
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -e PUBLIC_SPREADSHEET_ID="${{ env.PUBLIC_SPREADSHEET_ID }}" \
            -e GOOGLE_CREDENTIALS_JSON="${{ env.GOOGLE_CREDENTIALS_JSON }}" \
            -v $(pwd)/data:/app/data \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python upload.py

  # Optional: Run the full pipeline in a single job (useful for testing)
  full-pipeline:
    name: Full Pipeline (Single Job)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: gunzip -c docker-image.tar.gz | docker load

      - name: Run full pipeline
        run: |
          docker run --rm \
            -e RANKED_NGO_FNAME="${{ env.RANKED_NGO_FNAME }}" \
            -e PUBLIC_SPREADSHEET_ID="${{ env.PUBLIC_SPREADSHEET_ID }}" \
            -e GOOGLE_CREDENTIALS_JSON="${{ env.GOOGLE_CREDENTIALS_JSON }}" \
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            python main.py

